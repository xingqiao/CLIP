"use strict";var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){e.body;var a={touch:"ontouchend"in e,$:function(t,a,i){var n=i||"querySelector";return a&&a[n]?a[n](t):e[n](t)},$$:function(t,e){return this.$(t,e,"querySelectorAll")},transform:function(t,e,a,i){e=parseInt(e),a=parseInt(a),t.style.transformOrigin=t.style.webkitTransformOrigin=e+"px "+a+"px",t.style.transform=t.style.webkitTransform="translate("+-e+"px,"+-a+"px) scale("+i+")"},ondown:function(t,e){return a.touch?t.addEventListener("touchstart",e):t.addEventListener("mousedown",function(t){t.touches=[{pageX:t.pageX,pageY:t.pageY}],e.call(this,t)}),this},onmove:function(t,e){return a.touch?t.addEventListener("touchmove",e):t.addEventListener("mousemove",function(t){t.touches=[{pageX:t.pageX,pageY:t.pageY}],e.call(this,t)}),this},onup:function(t,e){return a.touch?(t.addEventListener("touchend",e),t.addEventListener("touchcancel",e)):t.addEventListener("mouseup",e),this},ontap:function(t,e){if(a.touch){var i=null,n=null,s=null,r=null;t.addEventListener("touchstart",function(t){1==t.touches.length&&(i=s=t.touches[0].pageX,n=r=t.touches[0].pageY)}),t.addEventListener("touchmove",function(t){null!=i&&(s=t.touches[0].pageX,r=t.touches[0].pageY)}),t.addEventListener("touchend",function(){Math.pow(i-s,2)+Math.pow(n-r,2)<400&&e.call(t),i=null})}else t.addEventListener("click",e);return this},extend:function(){var t=void 0,e=void 0,i=void 0,n=void 0,s=void 0,r=void 0,o=arguments,l=o[0]||{},c=1,h=o.length,u=!1;for(a.isBoolean(l)&&(u=l,l=o[c]||{},c++),c===h?(l={},c--):a.isObject(l)||a.isFunction(l)||(l={});c<h;c++)if(null!=(t=o[c]))for(e in t)i=l[e],l!==(n=t[e])&&(u&&n&&((s=Array.isArray(n))||a.isObject(n))?(s?(s=!1,r=i&&Array.isArray(i)?i:[]):r=i&&a.isObject(i)?i:{},l[e]=a.extend(u,r,n)):void 0!==n&&(l[e]=n));return l},parseImgOrientation:function(t,e){var a=new FileReader;function i(e,i,n){a.onload=function(t){if(this.result&&this.result.byteLength>0)try{var a=new Uint8Array(this.result,0,this.result.byteLength);n&&n(null,e,a)}catch(t){n&&n(t)}else n&&n("File End")};try{a.readAsArrayBuffer(t.slice(e,i))}catch(t){n&&n(t)}}function n(t,e,a,i){var n=0;a=a>0?a:0,i=i>0?i:e.length-a;for(var s=0;s<i;s++)n<<=8,n+=e[t?a+s:a+i-s-1];return n}i(0,8e3,function(t,a,s){255==s[0]&&216==s[1]?function t(e,a,s){255==a[0]&&225==a[1]?69==a[4]&&120==a[5]&&105==a[6]&&102==a[7]?s&&s(null,e+10,a.slice(10)):s&&s("Not Exif"):i(e+=n(!0,a,2,2),8e3,function(e,a,i){e?s&&s(e):t(a,i,s)})}(a+=2,s.slice(2),function(t,a,i){if(t)return e&&e("Not Exif");var s;if(73==i[0]&&73==i[1])s=0;else{if(77!=i[0]||77!=i[1])return e&&e("Unknown Endian");s=1}var r=n(s,i,4,4),o=n(s,i,r,2);r+=2;for(var l=0;l<o;l++){if(274==n(s,i,r,2)){var c=n(s,i,r+8,2);return e&&e(null,c)}r+=12}e&&e(null,0)}):e&&e("Not jpeg")})}};Array.prototype.forEach.call(["Object","Function","String","Number","Array","Boolean","File",{type:"Img",key:"HTMLImageElement"},{type:"Canvas",key:"HTMLCanvasElement"}],function(t){a["is"+(t.type||t)]=function(e){return Object.prototype.toString.call(e)==="[object "+(t.key||t)+"]"}});var i=function(){function i(t){_classCallCheck(this,i),this._initData(t)}return _createClass(i,null,[{key:"createCanvas",value:function(t,a){var i=e.createElement("canvas");return t>0&&(i.width=t),a>0&&(i.height=a),i}},{key:"loadImgToCanvas",value:function(t,e,a){var i=t.getContext("2d"),n=e.width,s=e.height;switch(a>=5&&a<=8&&(n=e.height,s=e.width),t.width=n,t.height=s,i.save(),a){case 2:i.translate(n,0),i.scale(-1,1);break;case 3:i.translate(n,s),i.rotate(Math.PI);break;case 4:i.translate(0,s),i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI),i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI),i.translate(0,-e.height);break;case 7:i.rotate(.5*Math.PI),i.translate(n,-e.height),i.scale(-1,1);break;case 8:i.rotate(-.5*Math.PI),i.translate(-e.width,0)}return i.clearRect(0,0,e.width,e.height),i.drawImage(e,0,0,e.width,e.height),i.restore(),{width:n,height:s,canvas:t}}},{key:"getFileUrl",value:function(e,i){if(a.isFunction(i))if(a.isFile(e)){var n;if(t.URL)try{n=URL.createObjectURL(e)}catch(t){}if(n)i(null,n);else try{var s=new FileReader;s.onload=function(){i(null,this.result)},s.onerror=i,s.readAsDataURL(e)}catch(t){i(t)}}else i()}}]),_createClass(i,[{key:"__loadingHandler",value:function(){this.__.state.load=i.STATE.LOADING,this._showLayer("loading")}},{key:"__loadHandler",value:function(){var t=this.__;if(t.state.load=i.STATE.LOADED,this.reset(),t.state.show){var e=t.iframe.contentDocument;a.$(".js_clip_save",e).className="js_clip_save",this._hideLayer()}}},{key:"__showHandler",value:function(){var t=this.__;if(t.state.load==i.STATE.LOADING)this._showLayer("loading");else if(t.state.load!=i.STATE.LOADED)this._showLayer("empty");else{var e=t.iframe.contentDocument;a.$(".js_clip_save",e).className="js_clip_save"}}},{key:"__hideHandler",value:function(){}},{key:"__saveHandler",value:function(){}},{key:"__errorHandler",value:function(t){var e=this.__;if(!t.message)switch(t.code){case i.ERROR.LOAD_IMG_FAIL:t.message="加载图片失败";break;case i.ERROR.SAVE_IMG_FAIL:t.message="保存图片失败";break;case i.ERROR.OPEN_FILE_FAIL:t.message="读取文件失败"}e.state.error=t,this._showLayer("error",t)}},{key:"_trigger",value:function(t,e){if(t&&a.isString(t)){var i=this["__"+t+"Handler"];i&&i.call(this,e),i=this.__.opts["on"+t.toLowerCase()],a.isFunction(i)&&i.call(this,e)}return this}},{key:"_showLayer",value:function(t,e){var i=this.__;if(i.state.show){var n,s=i.iframe.contentDocument;switch(t){case"loading":n="loading",e="正在加载中";break;case"error":n="error",e=e&&e.message||"操作失败";break;case"empty":n="file",e="选择文件"}if(n){e||(e="");var r=a.$(".js_layer",s);r.innerHTML='<div class="laver-wrap"><svg class="clip-icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon_'+n+'"></use></svg><span>'+e+"</span></div>",r.setAttribute("data-type",t),r.style.display=""}}return this}},{key:"_hideLayer",value:function(){var t=this.__;if(t.state.show){var e=t.iframe.contentDocument;a.$(".js_layer",e).style.display="none"}return this}},{key:"_setClipShapePath",value:function(t,e){var a=this.__,n=a.opts,s=a.view,r=t.width,o=t.height,l=t.getContext("2d"),c=Math.min(r,o),h=Math.max(0,parseInt((r-c)/2)),u=Math.max(0,parseInt((o-c)/2)),d=h+c,p=u+c;if(e){if(n.shape==i.SHAPE.RECT&&n.rectRatio>0){var f=n.rectRatio;f>1?(f=c*(f-1)/(2*f),u=parseInt(u+f),p=parseInt(p-f)):(f=c*(1-f)/2,h=parseInt(h+f),d=parseInt(d-f))}s.size=c,s.left=h,s.top=u,s.right=d,s.bottom=p}return e&&(l.save(),l.clearRect(0,0,r,o),l.fillStyle="rgba(0,0,0,.7)",l.fillRect(0,0,r,o)),l.beginPath(),n.shape==i.SHAPE.CIRCLE?l.arc(parseInt(r/2),parseInt(o/2),parseInt(c/2),0,2*Math.PI):l.rect(h,u,d-h,p-u),l.closePath(),e&&(l.clip(),l.clearRect(0,0,r,o),l.strokeStyle="#fff",l.stroke(),l.restore()),this}},{key:"_initData",value:function(t){var e=0;this.__&&this.__.state&&this.__.state.show&&(e=1,this.hide());var n={opts:{},state:{error:0,load:0,show:0},canvas:i.createCanvas(),iframe:null,content:"",width:0,height:0,view:{canvas:i.createCanvas(),width:0,height:0,size:0,btnsHeight:54,left:0,right:0,top:0,bottom:0},transform:{x:0,y:0,scale:1},random:parseInt(1e5*Math.random()),result:{type:"",quality:null,data:"",width:0,height:0}};this.__=n;for(var s in i.defaultOptions)n.opts[s]=i.defaultOptions[s];if(a.isObject(t))for(var s in t)/^on\w/.test(s)&&a.isFunction(t[s])?n.opts[s.toLowerCase()]=t[s]:n.opts[s]=t[s];return e&&this.show(),this}},{key:"_initDlg",value:function(){var n=this,s=n.__,r=(s.opts,s.view),o=s.iframe,l=s.content,c=s.transform;o||((o=e.createElement("iframe")).style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;border:0;z-index:99999",l="<style>\n                    body{margin:0;font:16px/1.5 sans-serif}\n                    a,a:hover{text-decoration:none}\n                    .clip,.layer{display:-webkit-box;display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background-color:#000;}\n                    .clip{-webkit-box-orient:vertical;flex-direction:column}\n                    .clip-cont{position:relative;-webkit-box-flex:1;flex:1;overflow:hidden}\n                    .clip-cont>*{position:absolute;left:0;top:0;}\n                    .clip-btns{display:-webkit-box;display:flex;width:100%;height:"+r.btnsHeight+'px;background:rgba(255,255,255,.1)}\n                    .clip-btns>*{display:block;padding:15px 0;width:50%;font-size:16px;color:#fff;text-align:center}\n                    .clip-btns>*:first-child{opacity:.7}\n                    .clip-icon{display:inline-block;width:32px;height:32px;fill:#fff;}\n                    .layer{-webkit-box-pack:center;-webkit-box-align:center;align-items:center;background:rgba(0,0,0,.5);color:#fff;line-height:50px;}\n                    .laver-wrap{width:100%;text-align:center}\n                    .laver-wrap>*{vertical-align:middle;}\n                    .laver-wrap svg{margin-right:5px;}\n                    .disable{opacity:.4}\n                    </style>\n                    <svg style="display:none;" xmlns="http://www.w3.org/2000/svg">\n                        <defs>\n                            <symbol id="icon_loading" viewBox="0 0 50 50">\n                                <path d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">\n                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"/>\n                                </path>\n                            </symbol>\n                            <symbol id="icon_error" viewBox="0 0 32 32">\n                                <path d="M18.086 20.232c0.083 0.090 0.133 0.21 0.133 0.342 0 0.279-0.226 0.505-0.505 0.505-0.154 0-0.292-0.069-0.385-0.177l-0.001 0.001c-0.003-0.004-0.006-0.008-0.009-0.013-0.007-0.009-0.014-0.018-0.021-0.028-0.52-0.688-1.346-1.132-2.275-1.132-0.898 0-1.699 0.415-2.222 1.064-0.085 0.165-0.257 0.278-0.455 0.278-0.283 0-0.511-0.229-0.511-0.512 0-0.144 0.059-0.273 0.155-0.366 0.697-0.913 1.796-1.503 3.034-1.503 1.254 0 2.367 0.606 3.062 1.541zM17.2 25.72v0h8.52c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v17.945c0 0.414 0.335 0.747 0.748 0.747h8.376l1.199 1.046 1.030 0h-1.029l1.2 1.047 1.117-1.047-0.96-0h0.961l1.116-1.046h-0.146zM17.495 26.766l-1.944 1.833c-0.24 0.227-0.635 0.234-0.884 0.016l-2.104-1.848h-8.524c-0.827 0-1.497-0.668-1.497-1.495v-18.543c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-8.522zM27.514 24.822v-1.047h0.149c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v0.15h-1.047v-0.449c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-0.447zM21.533 11.364l0.748 0.73-1.794 1.991 1.794 1.938-0.748 0.724-2.393-2.672 2.393-2.712zM8.374 11.364l2.393 2.712-2.393 2.672-0.748-0.724 1.794-1.938-1.794-1.991 0.748-0.73z"></path>\n                            </symbol>\n                            <symbol id="icon_file" viewBox="0 0 15 15">\n                                <path d="M14.969,0.031 L5,0.031 L5,2.969 L6,2.969 L6,1 L14.027,1 L14.027,8.001 L11,8.001 L11,10.952 L14.969,10.952 L14.969,0.031 Z" class="si-glyph-fill"></path>\n                                <path d="M0,4 L0,15 L10,15 L10,4 L0,4 L0,4 Z M8.967,12 L0.967,12 L0.967,5 L8.967,5 L8.967,12 L8.967,12 Z" class="si-glyph-fill"></path>\n                            </symbol>\n                        </defs>\n                    </svg>\n                    <div class="clip js_clip">\n                        <div class="clip-cont">\n                            <div class="js_clip_pic"></div>\n                            <canvas class="clip-cover js_clip_cover"></canvas>\n                            <div class="layer js_layer" style="display:none"></div>\n                        </div>\n                        <div class="clip-btns">\n                            <a class="js_clip_cancel" href="javascript:;">取消</a>\n                            <a class="js_clip_save disable" href="javascript:;">选取</a>\n                        </div>\n                    </div>',s.iframe=o,s.content=l),e.body.appendChild(o);var h=o.contentDocument;h.write(l),h.close();var u=parseInt(t.innerWidth),d=parseInt(t.innerHeight-r.btnsHeight);r.width=u,r.height=d;var p=a.$(".js_clip_cover",h);p.width=u,p.height=d,n._setClipShapePath(p,!0);var f,v=r.canvas;a.$(".js_clip_pic",h).appendChild(v);var g=0,_=function(t,e,i){var n=s.width,o=s.height,l=r.left/i,h=r.top/i,u=r.right/i,d=r.bottom/i;t=Math.min(Math.max(t,-l),n-u),e=Math.min(Math.max(e,-h),o-d),t>=-l&&t<=n-u&&e>=-h&&e<=o-d&&(c.x=t,c.y=e,c.scale=i,a.transform(v,t,e,i))};return a.ondown(p,function(t){if(s.state.show&&s.state.load==i.STATE.LOADED){g=1,f=[];for(var e=0,a=t.touches.length;e<a;e++)f.push({x:t.touches[e].pageX,y:t.touches[e].pageY})}t.preventDefault(),t.stopPropagation()}).onmove(p,function(t){if(g){s.width,s.height,r.size;var e,a,i,n,o=c.scale,l=t.touches[0].pageX,h=t.touches[0].pageY;if(2==t.touches.length&&2==f.length){i=t.touches[1].pageX,n=t.touches[1].pageY;var u=(f[0].x+f[1].x)/2,d=(f[0].y+f[1].y)/2,p=Math.sqrt(Math.pow(f[1].x-f[0].x,2)+Math.pow(f[1].y-f[0].y,2)),v=Math.sqrt(Math.pow(i-l,2)+Math.pow(n-h,2))/p,y=(v-1)/(o=c.scale*v);e=c.x+u*y,a=c.y+d*y}else e=c.x+(f[0].x-l)/o,a=c.y+(f[0].y-h)/o;_(e,a,o),f[0].x=l,f[0].y=h,2==f.length&&(f[1].x=i,f[1].y=n)}t.preventDefault(),t.stopPropagation()}).onup(p,function(){g=0}).ontap(a.$(".js_clip_cancel",h),function(){n.hide("cancel")}).ontap(a.$(".js_clip_save",h),function(){/disable/.test(this.className)||n.save()}).ontap(a.$(".js_layer",h),function(){if("empty"==this.getAttribute("data-type")){var t=a.$("#file",h);t||((t=h.createElement("input")).id="file",t.type="file",t.style.display="none",t.accept="image/*",h.body.appendChild(t),t.onchange=function(){this.files[0]&&n.load(this.files[0])}),t.click()}}),p.addEventListener("mousewheel",function(t){if(s.state.show&&s.state.load==i.STATE.LOADED){var e=c.scale*(t.deltaY>0?.9:1/.9),a=t.clientX,n=t.clientY,r=e-c.scale,o=c.x+a*r,l=c.y+n*r;_(o,l,e)}t.preventDefault(),t.stopPropagation()}),s.state.show=1,n}},{key:"load",value:function(t,e){var n=this,s=n.__;if(a.isFile(t))a.parseImgOrientation(t,function(e,a){i.getFileUrl(t,function(t,e){t?n._trigger(t,i.ERROR.OPEN_FILE_FAIL):e&&n.load(e,a)})});else{a.isImg(t)&&(t=t.src);var r=function(t){var a=i.loadImgToCanvas(s.canvas,t,e);s.width=a.width,s.height=a.height,n._trigger("load")};if(t&&a.isString(t)){n._trigger("loading");var o=new Image;o.crossOrigin="anonymous",o.onload=function(){r(o)},o.onerror=o.onabort=function(){n._trigger("error",{code:i.ERROR.LOAD_IMG_FAIL})},/^(?:blob|data):/i.test(t)||((t=t.split("#"))[0]=(t[0]+"&_random="+s.random).replace(/[?&]/,"?"),t=t.join("#")),o.src=t}else a.isCanvas(t)&&r(t)}return n}},{key:"save",value:function(t,e,n){var s,r,o=this.__,l=o.opts,c=o.view,h=o.transform;a.isFunction(t)?(n=t,t=e=null):a.isFunction(t)&&(n=e,e=null),null==t&&(t=l.type),null==e&&(e=l.quality);try{var u=h.scale,d=parseInt((c.right-c.left)/u),p=parseInt((c.bottom-c.top)/u),f=parseInt(h.x+c.left/u),v=parseInt(h.y+c.top/u),g=i.createCanvas(d,p),_=g.getContext("2d");if(l.background&&(_.fillStyle=l.background,_.fillRect(0,0,d,p)),l.shape==i.SHAPE.CIRCLE&&(this._setClipShapePath(g),_.clip()),_.drawImage(o.canvas,f,v,d,p,0,0,d,p),l.width>0||l.height>0){var y=l.width,w=l.height;y>0?w>0||(w=y*p/d):y=w*d/p,d=y,p=w;var m=i.createCanvas(d,p);(_=m.getContext("2d")).drawImage(g,0,0,g.width,g.height,0,0,d,p),g=m}r={type:t,quality:e,data:g.toDataURL(t,e),width:d,height:p},a.extend(o.result,r)}catch(t){s={code:i.ERROR.LOAD_IMG_FAIL,error:t}}return s?this._trigger("error",s):(this._trigger("save",r),this.hide("save")),a.isFunction(n)&&n(s,r),this}},{key:"show",value:function(){var t=this.__;t.opts;return t.state.show&&(e.body.removeChild(t.iframe),t.state.show=0),this._initDlg().reset()._trigger("show"),this}},{key:"hide",value:function(t){var a=this.__;return a.state.show&&(e.body.removeChild(a.iframe),a.state.show=0),this._trigger("hide",t||"hide"),this}},{key:"reset",value:function(){var t=this.__,e=t.view,n=t.transform;if(t.state.show&&t.state.load==i.STATE.LOADED){var s=e.canvas,r=s.getContext("2d");s.width=t.width,s.height=t.height,r.clearRect(0,0,t.width,t.height),r.drawImage(t.canvas,0,0);var o=1,l=0,c=0,h=e.width/t.width,u=e.height/t.height;h>u?(o=h,c=parseInt((t.height-e.height/o)/2)):(o=u,l=parseInt((t.width-e.width/o)/2)),n.x=l,n.y=c,n.scale=o,a.transform(s,l,c,o)}return this}},{key:"clear",value:function(){return this._initData(this.__.opts)}},{key:"result",get:function(){return a.extend({},this.__.result)}},{key:"width",get:function(){return this.__.opts.width},set:function(t){t>0&&(this.__.opts.width=t)}},{key:"height",get:function(){return this.__.opts.height},set:function(t){t>0&&(this.__.opts.height=t)}}]),i}();t.CLIP=i}(window,document),function(t){t.ERROR={LOAD_IMG_FAIL:1,SAVE_IMG_FAIL:2,OPEN_FILE_FAIL:3},t.STATE={LOADING:1,LOADED:2},t.SHAPE={CIRCLE:"circle",SQUARE:"square",RECT:"rect"},t.TYPE={JPG:"image/jpeg",PNG:"image/png"},t.defaultOptions={background:null,shape:t.SHAPE.SQUARE,type:t.TYPE.PNG,rectRatio:1,quality:"",width:null,height:null}}(window.CLIP);