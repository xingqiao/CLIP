"use strict";var _createClass=function(){function n(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(o,l){l.body;var b={touch:"ontouchend"in l,$:function(t,e,a){var n=a||"querySelector";return e&&e[n]?e[n](t):l[n](t)},$$:function(t,e){return this.$(t,e,"querySelectorAll")},transform:function(t,e,a,n){e=parseInt(e),a=parseInt(a),t.style.transformOrigin=t.style.webkitTransformOrigin=e+"px "+a+"px",t.style.transform=t.style.webkitTransform="translate("+-e+"px,"+-a+"px) scale("+n+")"},ondown:function(t,e){return b.touch?t.addEventListener("touchstart",e):t.addEventListener("mousedown",function(t){t.touches=[{pageX:t.pageX,pageY:t.pageY}],e.call(this,t)}),this},onmove:function(t,e){return b.touch?t.addEventListener("touchmove",e):t.addEventListener("mousemove",function(t){t.touches=[{pageX:t.pageX,pageY:t.pageY}],e.call(this,t)}),this},onup:function(t,e){return b.touch?(t.addEventListener("touchend",e),t.addEventListener("touchcancel",e)):t.addEventListener("mouseup",e),this},ontap:function(t,e){if(b.touch){var a=null,n=null,i=null,r=null;t.addEventListener("touchstart",function(t){1==t.touches.length&&(a=i=t.touches[0].pageX,n=r=t.touches[0].pageY)}),t.addEventListener("touchmove",function(t){null!=a&&(i=t.touches[0].pageX,r=t.touches[0].pageY)}),t.addEventListener("touchend",function(){Math.pow(a-i,2)+Math.pow(n-r,2)<400&&e.call(t),a=null})}else t.addEventListener("click",e);return this},extend:function(){var t=void 0,e=void 0,a=void 0,n=void 0,i=void 0,r=void 0,s=arguments,o=s[0]||{},l=1,c=s.length,h=!1;for(b.isBoolean(o)&&(h=o,o=s[l]||{},l++),l===c?(o={},l--):b.isObject(o)||b.isFunction(o)||(o={});l<c;l++)if(null!=(t=s[l]))for(e in t)a=o[e],o!==(n=t[e])&&(h&&n&&((i=Array.isArray(n))||b.isObject(n))?(r=i?(i=!1,a&&Array.isArray(a)?a:[]):a&&b.isObject(a)?a:{},o[e]=b.extend(h,r,n)):void 0!==n&&(o[e]=n));return o},parseImgOrientation:function(e,l){var i=new FileReader;function r(a,t,n){i.onload=function(t){if(this.result&&0<this.result.byteLength)try{var e=new Uint8Array(this.result,0,this.result.byteLength);n&&n(null,a,e)}catch(t){n&&n(t)}else n&&n("File End")};try{i.readAsArrayBuffer(e.slice(a,t))}catch(t){n&&n(t)}}function c(t,e,a,n){var i=0;a=0<a?a:0,n=0<n?n:e.length-a;for(var r=0;r<n;r++)i<<=8,i+=e[t?a+r:a+n-r-1];return i}r(0,8e3,function(t,e,a){255==a[0]&&216==a[1]?function n(t,e,i){255==e[0]&&225==e[1]?69==e[4]&&120==e[5]&&105==e[6]&&102==e[7]?i&&i(null,t+10,e.slice(10)):i&&i("Not Exif"):r(t+=c(!0,e,2,2),8e3,function(t,e,a){t?i&&i(t):n(e,a,i)})}(e+=2,a.slice(2),function(t,e,a){if(t)return l&&l("Not Exif");var n;if(73==a[0]&&73==a[1])n=0;else{if(77!=a[0]||77!=a[1])return l&&l("Unknown Endian");n=1}var i=c(n,a,4,4),r=c(n,a,i,2);i+=2;for(var s=0;s<r;s++){if(274==c(n,a,i,2)){var o=c(n,a,i+8,2);return l&&l(null,o)}i+=12}l&&l(null,0)}):l&&l("Not jpeg")})},base64toBlob:function(t,e){for(var a=atob(t,e),n=a.length,i=new Uint8Array(n);n--;)i[n]=a.charCodeAt(n);return new Blob([i],{type:e})}};Array.prototype.forEach.call(["Object","Function","String","Number","Array","Boolean","File",{type:"Img",key:"HTMLImageElement"},{type:"Canvas",key:"HTMLCanvasElement"}],function(e){b["is"+(e.type||e)]=function(t){return Object.prototype.toString.call(t)==="[object "+(e.key||e)+"]"}});var t=function(){function m(t){_classCallCheck(this,m),this._initData(t)}return _createClass(m,null,[{key:"createCanvas",value:function(t,e){var a=l.createElement("canvas");return 0<t&&(a.width=t),0<e&&(a.height=e),a}},{key:"loadImgToCanvas",value:function(t,e,a){var n=t.getContext("2d"),i=e.width,r=e.height;switch(5<=a&&a<=8&&(i=e.height,r=e.width),t.width=i,t.height=r,n.save(),a){case 2:n.translate(i,0),n.scale(-1,1);break;case 3:n.translate(i,r),n.rotate(Math.PI);break;case 4:n.translate(0,r),n.scale(1,-1);break;case 5:n.rotate(.5*Math.PI),n.scale(1,-1);break;case 6:n.rotate(.5*Math.PI),n.translate(0,-e.height);break;case 7:n.rotate(.5*Math.PI),n.translate(i,-e.height),n.scale(-1,1);break;case 8:n.rotate(-.5*Math.PI),n.translate(-e.width,0)}return n.clearRect(0,0,e.width,e.height),n.drawImage(e,0,0,e.width,e.height),n.restore(),{width:i,height:r,canvas:t}}},{key:"getFileUrl",value:function(t,e){if(b.isFunction(e))if(b.isFile(t)){var a;if(o.URL)try{a=URL.createObjectURL(t)}catch(t){}if(a)e(null,a);else try{var n=new FileReader;n.onload=function(){e(null,this.result)},n.onerror=e,n.readAsDataURL(t)}catch(t){e(t)}}else e()}}]),_createClass(m,[{key:"__loadingHandler",value:function(){this.__.state.load=m.STATE.LOADING,this._showLayer("loading")}},{key:"__loadHandler",value:function(){var t=this.__;if(t.state.load=m.STATE.LOADED,this.reset(),t.state.show){var e=t.iframe.contentDocument;b.$(".js_clip_save",e).className="js_clip_save",this._hideLayer()}}},{key:"__showHandler",value:function(){var t=this.__;if(t.state.load==m.STATE.LOADING)this._showLayer("loading");else if(t.state.load!=m.STATE.LOADED)this._showLayer("empty");else{var e=t.iframe.contentDocument;b.$(".js_clip_save",e).className="js_clip_save"}}},{key:"__hideHandler",value:function(){}},{key:"__saveHandler",value:function(){}},{key:"__errorHandler",value:function(t){var e=this.__;if(!t.message)switch(t.code){case m.ERROR.LOAD_IMG_FAIL:t.message="加载图片失败";break;case m.ERROR.SAVE_IMG_FAIL:t.message="保存图片失败";break;case m.ERROR.OPEN_FILE_FAIL:t.message="读取文件失败"}e.state.error=t,this._showLayer("error",t)}},{key:"_trigger",value:function(t,e){var a=this;if(t&&b.isString(t)){var n=a["__"+t+"Handler"];n&&n.call(a,e),n=a.__.opts["on"+t.toLowerCase()],b.isFunction(n)&&n.call(a,e)}return a}},{key:"_showLayer",value:function(t,e){var a=this.__;if(a.state.show){var n,i=a.iframe.contentDocument;switch(t){case"loading":n="loading",e="正在加载中";break;case"error":n="error",e=e&&e.message||"操作失败";break;case"empty":n="file",e="选择文件"}if(n){e||(e="");var r=b.$(".js_layer",i);r.innerHTML='<div class="laver-wrap"><svg class="clip-icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon_'+n+'"></use></svg><span>'+e+"</span></div>",r.setAttribute("data-type",t),r.style.display=""}}return this}},{key:"_hideLayer",value:function(){var t=this.__;if(t.state.show){var e=t.iframe.contentDocument;b.$(".js_layer",e).style.display="none"}return this}},{key:"_setClipShapePath",value:function(t,e){var a=this.__,n=a.opts,i=a.view,r=t.width,s=t.height,o=t.getContext("2d"),l=Math.min(r,s),c=Math.max(0,parseInt((r-l)/2)),h=Math.max(0,parseInt((s-l)/2)),u=c+l,d=h+l;if(e){if(n.shape==m.SHAPE.RECT&&0<n.rectRatio){var p=n.rectRatio;1<p?(p=l*(p-1)/(2*p),h=parseInt(h+p),d=parseInt(d-p)):(p=l*(1-p)/2,c=parseInt(c+p),u=parseInt(u-p))}i.size=l,i.left=c,i.top=h,i.right=u,i.bottom=d}return e&&(o.save(),o.clearRect(0,0,r,s),o.fillStyle="rgba(0,0,0,.7)",o.fillRect(0,0,r,s)),o.beginPath(),n.shape==m.SHAPE.CIRCLE?o.arc(parseInt(r/2),parseInt(s/2),parseInt(l/2),0,2*Math.PI):o.rect(c,h,u-c,d-h),o.closePath(),e&&(o.clip(),o.clearRect(0,0,r,s),o.strokeStyle="#fff",o.stroke(),o.restore()),this}},{key:"_initData",value:function(t){var e=this,a=0;e.__&&e.__.state&&e.__.state.show&&(a=1,e.hide());var n={opts:{},state:{error:0,load:0,show:0},canvas:m.createCanvas(),iframe:null,content:"",width:0,height:0,view:{canvas:m.createCanvas(),width:0,height:0,size:0,btnsHeight:54,left:0,right:0,top:0,bottom:0},transform:{x:0,y:0,scale:1},random:parseInt(1e5*Math.random()),result:{type:"",quality:null,data:"",width:0,height:0}};for(var i in e.__=n,m.defaultOptions)n.opts[i]=m.defaultOptions[i];if(b.isObject(t))for(var i in t)/^on\w/.test(i)&&b.isFunction(t[i])?n.opts[i.toLowerCase()]=t[i]:n.opts[i]=t[i];return a&&e.show(),e}},{key:"_initDlg",value:function(){var e=this,p=e.__,f=(p.opts,p.view),t=p.iframe,a=p.content,v=p.transform;t||((t=l.createElement("iframe")).style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;border:0;z-index:99999",a="<style>\n                    body{margin:0;font:16px/1.5 sans-serif}\n                    a,a:hover{text-decoration:none}\n                    .clip,.layer{display:-webkit-box;display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background-color:#000;}\n                    .clip{-webkit-box-orient:vertical;flex-direction:column}\n                    .clip-cont{position:relative;-webkit-box-flex:1;flex:1;overflow:hidden}\n                    .clip-cont>*{position:absolute;left:0;top:0;}\n                    .clip-btns{display:-webkit-box;display:flex;width:100%;height:"+f.btnsHeight+'px;background:rgba(255,255,255,.1)}\n                    .clip-btns>*{display:block;padding:15px 0;width:50%;font-size:16px;color:#fff;text-align:center}\n                    .clip-btns>*:first-child{opacity:.7}\n                    .clip-icon{display:inline-block;width:32px;height:32px;fill:#fff;}\n                    .layer{-webkit-box-pack:center;-webkit-box-align:center;align-items:center;background:rgba(0,0,0,.5);color:#fff;line-height:50px;}\n                    .laver-wrap{width:100%;text-align:center}\n                    .laver-wrap>*{vertical-align:middle;}\n                    .laver-wrap svg{margin-right:5px;}\n                    .disable{opacity:.4}\n                    </style>\n                    <svg style="display:none;" xmlns="http://www.w3.org/2000/svg">\n                        <defs>\n                            <symbol id="icon_loading" viewBox="0 0 50 50">\n                                <path d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">\n                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"/>\n                                </path>\n                            </symbol>\n                            <symbol id="icon_error" viewBox="0 0 32 32">\n                                <path d="M18.086 20.232c0.083 0.090 0.133 0.21 0.133 0.342 0 0.279-0.226 0.505-0.505 0.505-0.154 0-0.292-0.069-0.385-0.177l-0.001 0.001c-0.003-0.004-0.006-0.008-0.009-0.013-0.007-0.009-0.014-0.018-0.021-0.028-0.52-0.688-1.346-1.132-2.275-1.132-0.898 0-1.699 0.415-2.222 1.064-0.085 0.165-0.257 0.278-0.455 0.278-0.283 0-0.511-0.229-0.511-0.512 0-0.144 0.059-0.273 0.155-0.366 0.697-0.913 1.796-1.503 3.034-1.503 1.254 0 2.367 0.606 3.062 1.541zM17.2 25.72v0h8.52c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v17.945c0 0.414 0.335 0.747 0.748 0.747h8.376l1.199 1.046 1.030 0h-1.029l1.2 1.047 1.117-1.047-0.96-0h0.961l1.116-1.046h-0.146zM17.495 26.766l-1.944 1.833c-0.24 0.227-0.635 0.234-0.884 0.016l-2.104-1.848h-8.524c-0.827 0-1.497-0.668-1.497-1.495v-18.543c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-8.522zM27.514 24.822v-1.047h0.149c0.414 0 0.748-0.335 0.748-0.747v-17.945c0-0.414-0.335-0.747-0.748-0.747h-21.382c-0.414 0-0.748 0.335-0.748 0.747v0.15h-1.047v-0.449c0-0.826 0.67-1.495 1.497-1.495h21.979c0.827 0 1.497 0.668 1.497 1.495v18.543c0 0.826-0.67 1.495-1.497 1.495h-0.447zM21.533 11.364l0.748 0.73-1.794 1.991 1.794 1.938-0.748 0.724-2.393-2.672 2.393-2.712zM8.374 11.364l2.393 2.712-2.393 2.672-0.748-0.724 1.794-1.938-1.794-1.991 0.748-0.73z"></path>\n                            </symbol>\n                            <symbol id="icon_file" viewBox="0 0 15 15">\n                                <path d="M14.969,0.031 L5,0.031 L5,2.969 L6,2.969 L6,1 L14.027,1 L14.027,8.001 L11,8.001 L11,10.952 L14.969,10.952 L14.969,0.031 Z" class="si-glyph-fill"></path>\n                                <path d="M0,4 L0,15 L10,15 L10,4 L0,4 L0,4 Z M8.967,12 L0.967,12 L0.967,5 L8.967,5 L8.967,12 L8.967,12 Z" class="si-glyph-fill"></path>\n                            </symbol>\n                        </defs>\n                    </svg>\n                    <div class="clip js_clip">\n                        <div class="clip-cont">\n                            <div class="js_clip_pic"></div>\n                            <canvas class="clip-cover js_clip_cover"></canvas>\n                            <div class="layer js_layer" style="display:none"></div>\n                        </div>\n                        <div class="clip-btns">\n                            <a class="js_clip_cancel" href="javascript:;">取消</a>\n                            <a class="js_clip_save disable" href="javascript:;">选取</a>\n                        </div>\n                    </div>',p.iframe=t,p.content=a),l.body.appendChild(t);var n=t.contentDocument;n.write(a),n.close();var i=parseInt(o.innerWidth),r=parseInt(o.innerHeight-f.btnsHeight);f.width=i,f.height=r;var s=b.$(".js_clip_cover",n);s.width=i,s.height=r,e._setClipShapePath(s,!0);var g,c=f.canvas;b.$(".js_clip_pic",n).appendChild(c);var y=0,_=function(t,e,a){var n=p.width,i=p.height,r=f.left/a,s=f.top/a,o=f.right/a,l=f.bottom/a;t=Math.min(Math.max(t,-r),n-o),e=Math.min(Math.max(e,-s),i-l),-r<=t&&t<=n-o&&-s<=e&&e<=i-l&&(v.x=t,v.y=e,v.scale=a,b.transform(c,t,e,a))};return b.ondown(s,function(t){if(p.state.show&&p.state.load==m.STATE.LOADED){y=1,g=[];for(var e=0,a=t.touches.length;e<a;e++)g.push({x:t.touches[e].pageX,y:t.touches[e].pageY})}t.preventDefault(),t.stopPropagation()}).onmove(s,function(t){if(y){p.width,p.height,f.size;var e,a,n,i,r=v.scale,s=t.touches[0].pageX,o=t.touches[0].pageY;if(2==t.touches.length&&2==g.length){n=t.touches[1].pageX,i=t.touches[1].pageY;var l=(g[0].x+g[1].x)/2,c=(g[0].y+g[1].y)/2,h=Math.sqrt(Math.pow(g[1].x-g[0].x,2)+Math.pow(g[1].y-g[0].y,2)),u=Math.sqrt(Math.pow(n-s,2)+Math.pow(i-o,2))/h,d=(u-1)/(r=v.scale*u);e=v.x+l*d,a=v.y+c*d}else e=v.x+(g[0].x-s)/r,a=v.y+(g[0].y-o)/r;_(e,a,r),g[0].x=s,g[0].y=o,2==g.length&&(g[1].x=n,g[1].y=i)}t.preventDefault(),t.stopPropagation()}).onup(s,function(){y=0}).ontap(b.$(".js_clip_cancel",n),function(){e.hide("cancel")}).ontap(b.$(".js_clip_save",n),function(){/disable/.test(this.className)||e.save()}).ontap(b.$(".js_layer",n),function(){if("empty"==this.getAttribute("data-type")){var t=b.$("#file",n);t||((t=n.createElement("input")).id="file",t.type="file",t.style.display="none",t.accept="image/*",n.body.appendChild(t),t.onchange=function(){this.files[0]&&e.load(this.files[0])}),t.click()}}),s.addEventListener("mousewheel",function(t){if(p.state.show&&p.state.load==m.STATE.LOADED){var e=v.scale*(0<t.deltaY?.9:1/.9),a=1/v.scale-1/e,n=v.x+a*t.clientX,i=v.y+a*t.clientY;_(n,i,e)}t.preventDefault(),t.stopPropagation()}),p.state.show=1,e}},{key:"load",value:function(n,a){var i=this,r=i.__;if(null==a&&b.isFile(n))b.parseImgOrientation(n,function(t,a){m.getFileUrl(n,function(t,e){t?i._trigger(t,m.ERROR.OPEN_FILE_FAIL):e&&i.load(e,a)})});else if(null==a&&/^data:image/.test(n))try{var t=b.base64toBlob(n.replace(/^data:image\/\w+;base64,/,""));b.parseImgOrientation(t,function(t,e){i.load(n,e)})}catch(t){i.load(n,1)}else{b.isImg(n)&&(n=n.src);var e=function(t){var e=m.loadImgToCanvas(r.canvas,t,a);r.width=e.width,r.height=e.height,i._trigger("load")};if(n&&b.isString(n)){i._trigger("loading");var s=new Image;b.isString(n)&&/^data:image/.test(n)||(s.crossOrigin="anonymous"),s.onload=function(){e(s)},s.onerror=s.onabort=function(){i._trigger("error",{code:m.ERROR.LOAD_IMG_FAIL})},/^(?:blob|data):/i.test(n)||((n=n.split("#"))[0]=(n[0]+"&_random="+r.random).replace(/[?&]/,"?"),n=n.join("#")),s.src=n}else b.isCanvas(n)&&e(n)}return i}},{key:"save",value:function(t,e,a){var n,i,r=this,s=r.__,o=s.opts,l=s.view,c=s.transform;b.isFunction(t)?(a=t,t=e=null):b.isFunction(t)&&(a=e,e=null),null==t&&(t=o.type),null==e&&(e=o.quality);try{var h=c.scale,u=parseInt((l.right-l.left)/h),d=parseInt((l.bottom-l.top)/h),p=parseInt(c.x+l.left/h),f=parseInt(c.y+l.top/h),v=m.createCanvas(u,d),g=v.getContext("2d");if(o.background&&(g.fillStyle=o.background,g.fillRect(0,0,u,d)),o.shape==m.SHAPE.CIRCLE&&(r._setClipShapePath(v),g.clip()),g.drawImage(s.canvas,p,f,u,d,0,0,u,d),0<o.width||0<o.height){var y=o.width,_=o.height;0<y?0<_||(_=y*d/u):y=_*u/d;var w=m.createCanvas(u=y,d=_);(g=w.getContext("2d")).drawImage(v,0,0,v.width,v.height,0,0,u,d),v=w}i={type:t,quality:e,data:v.toDataURL(t,e),width:u,height:d},b.extend(s.result,i)}catch(t){n={code:m.ERROR.LOAD_IMG_FAIL,error:t}}return n?r._trigger("error",n):(r._trigger("save",i),r.hide("save")),b.isFunction(a)&&a(n,i),r}},{key:"show",value:function(){var t=this.__;t.opts;return t.state.show&&(l.body.removeChild(t.iframe),t.state.show=0),this._initDlg().reset()._trigger("show"),this}},{key:"hide",value:function(t){var e=this.__;return e.state.show&&(l.body.removeChild(e.iframe),e.state.show=0),this._trigger("hide",t||"hide"),this}},{key:"reset",value:function(){var t=this.__,e=t.view,a=t.transform;if(t.state.show&&t.state.load==m.STATE.LOADED){var n=e.canvas,i=n.getContext("2d");n.width=t.width,n.height=t.height,i.clearRect(0,0,t.width,t.height),i.drawImage(t.canvas,0,0);var r=1,s=0,o=0,l=e.width/t.width,c=e.height/t.height;c<l?(r=l,o=parseInt((t.height-e.height/r)/2)):(r=c,s=parseInt((t.width-e.width/r)/2)),a.x=s,a.y=o,a.scale=r,b.transform(n,s,o,r)}return this}},{key:"clear",value:function(){return this._initData(this.__.opts)}},{key:"result",get:function(){return b.extend({},this.__.result)}},{key:"width",get:function(){return this.__.opts.width},set:function(t){0<t&&(this.__.opts.width=t)}},{key:"height",get:function(){return this.__.opts.height},set:function(t){0<t&&(this.__.opts.height=t)}}]),m}();o.CLIP=t}(window,document),function(t){t.ERROR={LOAD_IMG_FAIL:1,SAVE_IMG_FAIL:2,OPEN_FILE_FAIL:3},t.STATE={LOADING:1,LOADED:2},t.SHAPE={CIRCLE:"circle",SQUARE:"square",RECT:"rect"},t.TYPE={JPG:"image/jpeg",PNG:"image/png"},t.defaultOptions={background:null,shape:t.SHAPE.SQUARE,type:t.TYPE.PNG,rectRatio:1,quality:"",width:null,height:null}}(window.CLIP);